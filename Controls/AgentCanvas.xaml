<UserControl x:Class="LangraphIDE.Controls.AgentCanvas"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             Background="{DynamicResource BackgroundBrush}">

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Toolbar -->
        <Border Grid.Row="0"
                Background="{DynamicResource SurfaceBrush}"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="0,0,0,1"
                Padding="6,6">
            <WrapPanel Orientation="Horizontal">
                <!-- Edit Toolbar -->
                <Border Background="{DynamicResource ControlBackgroundBrush}"
                        BorderBrush="{DynamicResource BorderBrush}"
                        BorderThickness="1"
                        CornerRadius="4"
                        Margin="0,0,6,0"
                        Height="36">
                    <StackPanel Orientation="Horizontal" Margin="4,0">
                        <Button x:Name="BtnUndo" Content="&#x21B6;" Width="26" Height="26"
                                Style="{DynamicResource ToolbarButton}"
                                Click="BtnUndo_Click" ToolTip="Undo (Ctrl+Z)"/>
                        <Button x:Name="BtnRedo" Content="&#x21B7;" Width="26" Height="26"
                                Style="{DynamicResource ToolbarButton}"
                                Click="BtnRedo_Click" ToolTip="Redo (Ctrl+Y)"/>
                        <Rectangle Width="1" Fill="{DynamicResource BorderBrush}" Margin="4,6"/>
                        <Button x:Name="BtnDelete" Content="&#x2716;" Width="26" Height="26"
                                Style="{DynamicResource ToolbarButton}"
                                Click="BtnDelete_Click" ToolTip="Delete (Del)"/>
                        <Button x:Name="BtnCopy" Content="&#x2398;" Width="26" Height="26"
                                Style="{DynamicResource ToolbarButton}"
                                Click="BtnCopy_Click" ToolTip="Copy (Ctrl+C)"/>
                        <Button x:Name="BtnPaste" Content="&#x2399;" Width="26" Height="26"
                                Style="{DynamicResource ToolbarButton}"
                                Click="BtnPaste_Click" ToolTip="Paste (Ctrl+V)"/>
                    </StackPanel>
                </Border>

                <!-- View Toolbar -->
                <Border Background="{DynamicResource ControlBackgroundBrush}"
                        BorderBrush="{DynamicResource BorderBrush}"
                        BorderThickness="1"
                        CornerRadius="4"
                        Margin="0,0,6,0"
                        Height="36">
                    <StackPanel Orientation="Horizontal" Margin="4,0">
                        <Button x:Name="BtnZoomOut" Content="-" Width="26" Height="26"
                                Style="{DynamicResource ToolbarButton}"
                                Click="BtnZoomOut_Click" ToolTip="Zoom Out"/>
                        <TextBlock x:Name="ZoomText" Text="100%"
                                   Foreground="{DynamicResource TextSecondaryBrush}"
                                   VerticalAlignment="Center"
                                   FontSize="10"
                                   Width="40" TextAlignment="Center"/>
                        <Button x:Name="BtnZoomIn" Content="+" Width="26" Height="26"
                                Style="{DynamicResource ToolbarButton}"
                                Click="BtnZoomIn_Click" ToolTip="Zoom In"/>
                        <Button x:Name="BtnZoomReset" Content="1:1" Width="34" Height="26"
                                Style="{DynamicResource ToolbarButton}"
                                Click="BtnZoomReset_Click" ToolTip="Reset Zoom"/>
                        <Rectangle Width="1" Fill="{DynamicResource BorderBrush}" Margin="4,6"/>
                        <Button x:Name="BtnFitToView" Content="&#x25A3;" Width="26" Height="26"
                                Style="{DynamicResource ToolbarButton}"
                                Click="BtnFitToView_Click" ToolTip="Fit to View"/>
                    </StackPanel>
                </Border>

                <!-- Generate Code Button -->
                <Button x:Name="BtnGenerateCode"
                        Style="{DynamicResource PrimaryButton}"
                        Click="BtnGenerateCode_Click"
                        Height="36"
                        ToolTip="Generate Python Langraph Code">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="&#x2261;" FontSize="14" Margin="0,0,6,0"/>
                        <TextBlock Text="Generate Code"/>
                    </StackPanel>
                </Button>
            </WrapPanel>
        </Border>

        <!-- Canvas with scroll and zoom -->
        <ScrollViewer x:Name="CanvasScrollViewer"
                      Grid.Row="1"
                      HorizontalScrollBarVisibility="Auto"
                      VerticalScrollBarVisibility="Auto"
                      PreviewMouseWheel="CanvasScrollViewer_PreviewMouseWheel"
                      PreviewMouseLeftButtonDown="CanvasScrollViewer_PreviewMouseLeftButtonDown"
                      PreviewMouseLeftButtonUp="CanvasScrollViewer_PreviewMouseLeftButtonUp"
                      PreviewMouseMove="CanvasScrollViewer_PreviewMouseMove"
                      PreviewMouseRightButtonUp="CanvasScrollViewer_PreviewMouseRightButtonUp">
            <Grid x:Name="ZoomContainer">
                <Grid.LayoutTransform>
                    <ScaleTransform x:Name="ZoomTransform" ScaleX="1" ScaleY="1"/>
                </Grid.LayoutTransform>

                <!-- Grid background pattern (fill set in code-behind for theme support) -->
                <Rectangle x:Name="GridBackground"
                           Fill="{DynamicResource BackgroundBrush}"
                           Width="3840" Height="2160"/>
                <Rectangle x:Name="GridPattern"
                           Width="3840" Height="2160"
                           IsHitTestVisible="False"/>

                <!-- Connections layer -->
                <Canvas x:Name="ConnectionsCanvas"
                        Width="3840" Height="2160"
                        Background="Transparent"/>

                <!-- Nodes layer -->
                <Canvas x:Name="NodesCanvas"
                        Width="3840" Height="2160"
                        Background="Transparent"
                        AllowDrop="True"
                        Drop="Canvas_Drop"
                        DragOver="Canvas_DragOver"/>

                <!-- Connection hit area layer (above nodes for click detection) -->
                <Canvas x:Name="ConnectionHitCanvas"
                        Width="3840" Height="2160"
                        IsHitTestVisible="True"/>

                <!-- Selection rectangle overlay -->
                <Canvas x:Name="SelectionCanvas"
                        Width="3840" Height="2160"
                        Background="Transparent"
                        IsHitTestVisible="False">
                    <Rectangle x:Name="SelectionRectangle"
                               Stroke="#58A6FF"
                               StrokeThickness="1"
                               StrokeDashArray="4,2"
                               Fill="#2058A6FF"
                               Visibility="Collapsed"/>
                </Canvas>
            </Grid>
        </ScrollViewer>
    </Grid>
</UserControl>
